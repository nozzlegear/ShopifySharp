name: Generate GraphQL Types

on:
  workflow_dispatch:
    inputs:
      schema_version:
        description: 'Shopify API version (e.g., 2025-07)'
        required: true
        type: string

jobs:
  generate-types:
    runs-on: ubuntu-latest
    environment: "Unit test environment"

    env:
      SCHEMA_JSON_FILE: "${{ github.event.inputs.schema_version }}.schema.json"
      SCHEMA_GRAPHQL_FILE: "graphql.schema.graphql"

    steps:
    - name: Checkout code
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

    - name: Setup .NET
      uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
      with:
        dotnet-version: |
          10.0.x

    - name: Setup justfile
      uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3.0.0
      with:
        just-version: '1.46.0'

    - name: Restore dependencies
      run: dotnet restore

    - name: Download GraphQL schema
      run: just download-graphql-schema --api-version ${{ github.event.inputs.schema_version }} --domain "${{ secrets.SHOPIFYSHARP_MY_SHOPIFY_URL }}" --token "${{ secrets.SHOPIFYSHARP_ACCESS_TOKEN }}" --output "${{ env.SCHEMA_JSON_FILE }}"

    - name: Convert JSON schema to GraphQL
      run: just convert-graphql-schema --input "${{ env.SCHEMA_JSON_FILE }}" --output "${{ env.SCHEMA_GRAPHQL_FILE }}"

    - name: Clean output directory
      run: just clean

    - name: Regenerate types from new schema
      run: just regenerate-and-build

    - name: Create pull request
      run: just create-graphql-pr --schema-file "${{ env.SCHEMA_GRAPHQL_FILE }}" --token "${{ secrets.GITHUB_TOKEN }}"
